<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulasi Jaringan — HTML + D3</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;display:flex;height:100vh}
    #controls{width:300px;padding:16px;border-right:1px solid #ddd;background:#f8f9fb}
    #view{flex:1;display:flex;flex-direction:column}
    h2{margin-top:0}
    label{display:block;margin-top:12px;font-weight:600}
    select, button, input{width:100%;padding:8px;margin-top:6px}
    svg{flex:1;background:linear-gradient(180deg,#ffffff,#f3f7ff)}
    .node circle{stroke:#444;stroke-width:1.2}
    .node.end circle{fill:#bfe9ff}
    .node.switch circle{fill:#c8f0c0}
    .node.router circle{fill:#ffd39b}
    .edge{stroke:#999;stroke-width:2}
    .edge.active{stroke:red;stroke-width:4}
    .node.active circle{stroke:red;stroke-width:3}
    #log{height:140px;overflow:auto;border-top:1px solid #ddd;padding:8px;background:#fff;font-size:13px}
    .small{font-size:12px;color:#666}
  </style>
</head>
<body>
  <div id="controls">
    <h2>Simulasi Jaringan</h2>
    <p class="small">Pilih pengirim dan penerima lalu klik <strong>Kirim Paket</strong>.</p>

    <label for="src">Source (Pengirim)</label>
    <select id="src"></select>

    <label for="dst">Destination (Penerima)</label>
    <select id="dst"></select>

    <label for="payload">Payload (isi paket)</label>
    <input id="payload" value="Halo dari PC!" />

    <button id="sendBtn">Kirim Paket</button>

    <hr />
    <h3>Topologi</h3>
    <p class="small">Topologi diperpanjang: PC1 & PC2 di SW1 → Router R1 → SW2 → Router R2 → SW3 → PC3 & PC4.</p>

    <button id="resetBtn">Reset Highlight</button>

    <div id="log"></div>
  </div>

  <div id="view">
    <svg id="svgCanvas"></svg>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // Node lebih panjang: PC1, PC2 -> SW1 -> R1 -> SW2 -> R2 -> SW3 -> PC3, PC4
    const nodes = [
      {id:'PC1', type:'end', ip:'10.0.1.2', x:80, y:120},
      {id:'PC2', type:'end', ip:'10.0.1.3', x:80, y:220},
      {id:'SW1', type:'switch', ip:null, x:240, y:170},
      {id:'R1', type:'router', ip:null, x:420, y:170},
      {id:'SW2', type:'switch', ip:null, x:600, y:170},
      {id:'R2', type:'router', ip:null, x:780, y:170},
      {id:'SW3', type:'switch', ip:null, x:960, y:170},
      {id:'PC3', type:'end', ip:'10.0.2.2', x:1140, y:120},
      {id:'PC4', type:'end', ip:'10.0.2.3', x:1140, y:220}
    ];

    const links = [
      {source:'PC1', target:'SW1'},
      {source:'PC2', target:'SW1'},
      {source:'SW1', target:'R1'},
      {source:'R1', target:'SW2'},
      {source:'SW2', target:'R2'},
      {source:'R2', target:'SW3'},
      {source:'SW3', target:'PC3'},
      {source:'SW3', target:'PC4'}
    ];

    function nodeById(id){ return nodes.find(n=>n.id===id); }

    const svg = d3.select('#svgCanvas');
    const width = document.getElementById('view').clientWidth;
    const height = document.getElementById('view').clientHeight;
    svg.attr('width',width).attr('height',height);

    const linkGroup = svg.append('g').attr('class','links');
    const nodeGroup = svg.append('g').attr('class','nodes');

    function draw(){
      linkGroup.selectAll('*').remove();
      nodeGroup.selectAll('*').remove();

      linkGroup.selectAll('line').data(links).enter()
        .append('line')
        .attr('class','edge')
        .attr('x1',d=>nodeById(d.source).x)
        .attr('y1',d=>nodeById(d.source).y)
        .attr('x2',d=>nodeById(d.target).x)
        .attr('y2',d=>nodeById(d.target).y)
        .attr('id',d=>`e-${d.source}-${d.target}`);

      const n = nodeGroup.selectAll('g').data(nodes).enter().append('g')
        .attr('class', d=>`node ${d.type}`)
        .attr('transform', d => `translate(${d.x},${d.y})`)
        .attr('id', d => `n-${d.id}`);

      n.append('circle').attr('r',28);
      n.append('text').text(d=>d.id).attr('y',40).attr('text-anchor','middle');
      n.append('text').text(d=>d.ip?d.ip:'').attr('y',-36).attr('text-anchor','middle').attr('class','small');
    }
    draw();

    const pcList = nodes.filter(n=>n.type==='end').map(n=>n.id);
    const srcSel = document.getElementById('src');
    const dstSel = document.getElementById('dst');
    pcList.forEach((p,i)=>{
      const o1=document.createElement('option');o1.value=p;o1.text=p;srcSel.add(o1);
      const o2=document.createElement('option');o2.value=p;o2.text=p;dstSel.add(o2);
    });
    srcSel.selectedIndex=0; dstSel.selectedIndex=1;

    function computePath(src,dst){
      const adj={}; nodes.forEach(n=>adj[n.id]=[]);
      links.forEach(l=>{adj[l.source].push(l.target);adj[l.target].push(l.source)});
      const q=[src]; const prev={}; prev[src]=null;
      while(q.length){
        const u=q.shift(); if(u===dst) break;
        for(const v of adj[u]){ if(!(v in prev)){ prev[v]=u; q.push(v);} }
      }
      if(!(dst in prev)) return null;
      const path=[]; let cur=dst; while(cur){ path.unshift(cur); cur=prev[cur]; }
      return path;
    }

    function log(msg){
      const el=document.getElementById('log');
      const p=document.createElement('div');p.textContent=msg;el.prepend(p);
    }

    function resetHighlights(){
      svg.selectAll('.edge').classed('active',false);
      svg.selectAll('.node').classed('active',false);
      document.getElementById('log').innerHTML='';
    }
    document.getElementById('resetBtn').addEventListener('click',resetHighlights);

    async function animatePath(path,payload){
      if(!path) return;
      resetHighlights();
      log(`Mengirim dari ${path[0]} ke ${path[path.length-1]}: "${payload}"`);
      for(let i=0;i<path.length;i++){
        const nid=path[i];
        d3.select(`#n-${nid}`).classed('active',true);
        log(`Hop ${i+1}: ${nid}`);
        if(i>0){
          const a=path[i-1], b=path[i];
          const e1=d3.select(`#e-${a}-${b}`);
          const e2=d3.select(`#e-${b}-${a}`);
          if(!e1.empty()) e1.classed('active',true);
          if(!e2.empty()) e2.classed('active',true);
        }
        await new Promise(r=>setTimeout(r,700));
      }
      log(`Paket sampai di ${path[path.length-1]} ✅`);
    }

    document.getElementById('sendBtn').addEventListener('click',()=>{
      const src=srcSel.value; const dst=dstSel.value; const payload=document.getElementById('payload').value;
      if(src===dst){alert('Source dan destination sama.');return;}
      const path=computePath(src,dst);
      if(!path){alert('Tidak ada jalur antara '+src+' dan '+dst);return;}
      animatePath(path,payload);
    });

    window.addEventListener('resize',()=>{
      const w=document.getElementById('view').clientWidth;
      const h=document.getElementById('view').clientHeight;
      svg.attr('width',w).attr('height',h);
    });
  </script>
</body>
</html>
